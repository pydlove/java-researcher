<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨å¢¨è¯´-Java Unsafe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        body {
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background-color: #FFF5F5;
            justify-content: center;
        }
        .card {
            width: 450px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header {
            height: 20px;
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            position: relative;
        }
        .header::before {
            content: "";
            position: absolute;
            width: 10px;
            height: 20px;
            background: #FF9A8B;
            border-radius: 0 5px 5px 0;
        }
        .content {
            padding: 20px;
            flex: 1;
            overflow: hidden;
        }
        .footer {
            height: 60px;
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        h1 {
            color: #FF6B6B;
            font-size: 24px;
            margin-bottom: 15px;
        }
        h2 {
            color: #FF8E53;
            font-size: 18px;
            margin: 15px 0 10px;
        }
        p, li {
            font-size: 14px;
            line-height: 1.6;
            color: #333333;
            margin-bottom: 10px;
        }
        ul {
            padding-left: 20px;
        }
        .highlight {
            background-color: rgba(255, 107, 107, 0.3);
            padding: 0.1em 0.3em;
            border-radius: 3px;
        }
        .code-block {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            font-family: Consolas, Monaco, "Courier New", monospace;
            font-size: 12px;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre;
        }
        .warning {
            background-color: rgba(255, 223, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .danger {
            background-color: rgba(255, 107, 107, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #FF6B6B;
        }
        .success {
            background-color: rgba(107, 255, 142, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .feature-item {
            background: #F5F5F5;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
        }
        .memory-diagram {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        .heap { background: #FFE6E6; padding: 10px; border-radius: 8px; }
        .off-heap { background: #E6F3FF; padding: 10px; border-radius: 8px; }
        .arrow { margin: 0 10px; font-size: 20px; color: #FF6B6B; }
    </style>
</head>
<body>
<!-- å°é¢å¡ -->
<div class="card">
    <div class="header"></div>
    <div class="content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
        <h1 style="color: white; font-size: 28px; text-align: center;">é¢è¯•å¿…é—®: ä»€ä¹ˆæ˜¯ Java Unsafe</h1>
        <p style="color: white; text-align: center; font-size: 16px;">Javaçš„"åé—¨"æ“ä½œ</p>
        <div class="code-block" style="background: rgba(255,255,255,0.2); color: white;">
            // å±é™©ä½†å¼ºå¤§çš„å·¥å…·<br>
            Unsafe unsafe = getUnsafe();<br>
            long addr = unsafe.allocateMemory(1024);
        </div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>

<!-- å¡ç‰‡1ï¼šæ ¸å¿ƒç‰¹æ€§ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>æ ¸å¿ƒç‰¹æ€§</h1>

        <div class="feature-grid">
            <div class="feature-item">
                <strong>å†…å­˜æ“ä½œ</strong>
                <div style="font-size: 12px;">ç›´æ¥åˆ†é…/é‡Šæ”¾å †å¤–å†…å­˜</div>
            </div>
            <div class="feature-item">
                <strong>ç»•è¿‡é™åˆ¶</strong>
                <div style="font-size: 12px;">å®ä¾‹åŒ–å¯¹è±¡ã€ä¿®æ”¹finalå­—æ®µ</div>
            </div>
            <div class="feature-item">
                <strong>CASæ“ä½œ</strong>
                <div style="font-size: 12px;">åŸå­æ€§æ¯”è¾ƒå¹¶äº¤æ¢</div>
            </div>
            <div class="feature-item">
                <strong>çº¿ç¨‹æ§åˆ¶</strong>
                <div style="font-size: 12px;">æŒ‚èµ·/æ¢å¤çº¿ç¨‹</div>
            </div>
        </div>

        <h2>åŒ…ä½ç½®ä¸è®¿é—®é™åˆ¶</h2>
        <div class="code-block">package sun.misc.Unsafe;  // JDKå†…éƒ¨åŒ…

// è·å–å®ä¾‹çš„å›°éš¾æ€§
public static Unsafe getUnsafe() {
    // é»˜è®¤æŠ›å‡ºSecurityException
    throw new SecurityException("Unsafe");
}</div>

        <div class="warning">
            âš ï¸ Unsafeä½äºsun.miscåŒ…ï¼Œæ˜¯JDKå†…éƒ¨API
        </div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>

<!-- å¡ç‰‡2ï¼šç›´æ¥å†…å­˜æ“ä½œ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>ç›´æ¥å†…å­˜æ“ä½œ</h1>

        <div class="memory-diagram">
            <div class="heap">JVMå †å†…å­˜</div>
            <div class="arrow">â†â†’</div>
            <div class="off-heap">å †å¤–å†…å­˜</div>
        </div>

        <h2>å †å¤–å†…å­˜ç®¡ç†</h2>
        <div class="code-block">// åˆ†é…å †å¤–å†…å­˜ï¼ˆç±»ä¼¼Cçš„mallocï¼‰
long address = unsafe.allocateMemory(1024);

// å†™å…¥æ•°æ®
unsafe.putInt(address, 123);
unsafe.putByte(address + 4, (byte) 1);

// è¯»å–æ•°æ®
int value = unsafe.getInt(address);

// é‡Šæ”¾å†…å­˜ï¼ˆå¿…é¡»æ‰‹åŠ¨è°ƒç”¨ï¼ï¼‰
unsafe.freeMemory(address);
        </div>

    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>


<!-- å¡ç‰‡2ï¼šç›´æ¥å†…å­˜æ“ä½œ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>ç›´æ¥å†…å­˜æ“ä½œ</h1>

        <h2>å†…å­˜åœ°å€æ“ä½œ</h2>
        <div class="code-block">// é€šè¿‡åç§»é‡æ“ä½œå¯¹è±¡å­—æ®µ
class Data {
    private int value = 42;
}

Data obj = new Data();
long offset = unsafe.objectFieldOffset(
Data.class.getDeclaredField("value"));

// ç›´æ¥ä¿®æ”¹ç§æœ‰å­—æ®µ
unsafe.putInt(obj, offset, 100);</div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>

<!-- å¡ç‰‡3ï¼šç»•è¿‡JVMé™åˆ¶ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>ç»•è¿‡JVMé™åˆ¶</h1>

        <h2>ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡</h2>
        <div class="code-block">
class SecretClass {
    private SecretClass() {  // ç§æœ‰æ„é€ 
        throw new RuntimeException("ä¸åº”è¯¥è¢«å®ä¾‹åŒ–");
    }
}

// ç»•è¿‡æ„é€ å‡½æ•°ç›´æ¥å®ä¾‹åŒ–
SecretClass instance = (SecretClass)
unsafe.allocateInstance(SecretClass.class);
// ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸
        </div>

        <div class="danger">
            â— è¿™äº›æ“ä½œç ´åäº†Javaçš„å®‰å…¨æ¨¡å‹å’Œä¸å˜æ€§ä¿è¯
        </div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>

<!-- å¡ç‰‡5ï¼šé£é™©ä¸é™åˆ¶ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>é£é™©ä¸é™åˆ¶</h1>

        <div class="danger">
            <h2>ä¸»è¦é£é™©</h2>
            <ul>
                <li><span class="highlight">JVMå´©æºƒ</span>ï¼šé”™è¯¯çš„å†…å­˜æ“ä½œå¯èƒ½å¯¼è‡´JVMå¼‚å¸¸é€€å‡º</li>
                <li><span class="highlight">å†…å­˜æ³„æ¼</span>ï¼šå¿˜è®°é‡Šæ”¾åˆ†é…çš„å †å¤–å†…å­˜</li>
                <li><span class="highlight">æ•°æ®æŸå</span>ï¼šå¹¶å‘ç¯å¢ƒä¸‹çš„ä¸å®‰å…¨æ“ä½œ</li>
            </ul>
        </div>

        <h2>ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜</h2>
        <table class="comparison-table">
            <tr>
                <th>JDKç‰ˆæœ¬</th>
                <th>UnsafeçŠ¶æ€</th>
                <th>æ›¿ä»£æ–¹æ¡ˆ</th>
            </tr>
            <tr>
                <td>Java 8</td>
                <td>å¯ç”¨ä½†å—é™</td>
                <td>åå°„è·å–</td>
            </tr>
            <tr>
                <td>Java 9+</td>
                <td>é€æ­¥é™åˆ¶</td>
                <td>VarHandle</td>
            </tr>
            <tr>
                <td>Java 16+</td>
                <td>å¼ºå°è£…</td>
                <td>--add-opens</td>
            </tr>
        </table>

        <h2>è®¿é—®é™åˆ¶è§£å†³æ–¹æ¡ˆ</h2>
        <div class="code-block">
            // é€šè¿‡åå°„è·å–Unsafeå®ä¾‹
            public static Unsafe getUnsafe() throws Exception {
            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            return (Unsafe) theUnsafe.get(null);
            }

            // JVMå‚æ•°ç»•è¿‡é™åˆ¶
            --add-opens java.base/jdk.internal.misc=ALL-UNNAMED
        </div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>

<!-- å¡ç‰‡6ï¼šæ›¿ä»£æ–¹æ¡ˆä¸æœ€ä½³å®è·µ -->
<div class="card">
    <div class="header"></div>
    <div class="content">
        <h1>æ›¿ä»£æ–¹æ¡ˆä¸æœ€ä½³å®è·µ</h1>

        <h2>æ¨èçš„ä½¿ç”¨åœºæ™¯</h2>
        <ul>
            <li><span class="highlight">é«˜æ€§èƒ½åº“å¼€å‘</span>ï¼šå¦‚Nettyã€Disruptor</li>
            <li><span class="highlight">JVMå·¥å…·å¼€å‘</span>ï¼šæ€§èƒ½ç›‘æ§ã€è°ƒè¯•å·¥å…·</li>
            <li><span class="highlight">ç ”ç©¶å­¦ä¹ </span>ï¼šç†è§£JVMå†…éƒ¨æœºåˆ¶</li>
        </ul>

        <h2>æœ€ä½³å®è·µ</h2>
        <div class="success">
            âœ… ä¼˜å…ˆä½¿ç”¨æ ‡å‡†åº“ï¼ˆAtomicç±»ã€LockSupportç­‰ï¼‰<br>
            âœ… å¦‚å¿…é¡»ä½¿ç”¨ï¼Œå……åˆ†æµ‹è¯•å¹¶æ·»åŠ è¯¦ç»†æ³¨é‡Š<br>
            âœ… è€ƒè™‘ä½¿ç”¨ByteBufferç­‰æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ<br>
            âœ… æ–°é¡¹ç›®ä¼˜å…ˆè€ƒè™‘VarHandleç­‰ç°ä»£API
        </div>

        <div class="warning">
            ğŸ’¡ Unsafeæ˜¯å¼ºå¤§çš„å·¥å…·ï¼Œä½†"èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§"
        </div>
    </div>
    <div class="footer">å¢¨å¢¨è¯´-Java</div>
</div>
</body>
</html>